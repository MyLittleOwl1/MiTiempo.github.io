<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Meteo AEMET Móvil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

  <style>
    :root {
      --color-bg: #0b1120;
      --color-bg-card: #111827;
      --color-accent: #38bdf8;
      --color-text: #e5e7eb;
      --color-text-soft: #9ca3af;
      --radius-card: 14px;
      --shadow-card: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d243a 0, #020617 55%);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      padding: 12px;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      padding: 8px 4px 0 4px;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .badge {
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--color-text-soft);
    }

    .subtitle {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--color-text-soft);
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937, #020617 70%);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-card);
      padding: 14px 14px 12px 14px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      color: var(--color-text-soft);
      border: 1px solid rgba(55, 65, 81, 0.8);
    }

    .status-text {
      font-size: 0.7rem;
      color: var(--color-text-soft);
      text-align: right;
    }

    .current-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .current-temp {
      font-size: 2.8rem;
      font-weight: 700;
    }

    .current-temp span {
      font-size: 1.2rem;
      color: var(--color-text-soft);
    }

    .current-extra {
      font-size: 0.75rem;
      color: var(--color-text-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .chip {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .forecast-list {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding-bottom: 4px;
      margin-top: 4px;
    }

    .forecast-item {
      min-width: 70px;
      max-width: 80px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 12px;
      padding: 6px 6px 4px 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.7rem;
      text-align: center;
    }

    .forecast-hour {
      font-weight: 600;
      color: var(--color-text-soft);
    }

    .forecast-temp {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .forecast-desc {
      font-size: 0.65rem;
      color: var(--color-text-soft);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.7rem;
      color: var(--color-text-soft);
    }

    .btn-refresh {
      padding: 6px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      background: linear-gradient(to right, #22d3ee, #3b82f6);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-refresh:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .error {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #fecaca;
    }

    .hidden {
      display: none;
    }

    footer {
      margin-top: 4px;
      padding: 4px;
      font-size: 0.65rem;
      color: var(--color-text-soft);
      text-align: center;
    }

    @media (min-width: 640px) {
      body {
        padding: 16px;
      }
      .app-title {
        font-size: 1.7rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="app-title">
        <span>Meteo AEMET</span>
        <span class="badge">Mobile · Beta</span>
      </div>
      <p class="subtitle">
        Datos oficiales de AEMET: observación por estación y predicción horaria por municipio.
      </p>
    </header>

    <!-- TIEMPO ACTUAL -->
    <section class="card" id="card-actual">
      <div class="card-header">
        <div class="card-title">
          <span>Tiempo actual</span>
          <span class="pill" id="station-label">Estación —</span>
        </div>
        <div class="status-text" id="status-actual">Esperando datos…</div>
      </div>

      <div class="current-main">
        <div class="current-temp" id="temp-actual">
          --<span>°C</span>
        </div>
        <div class="current-extra">
          <span id="humedad-actual">Humedad: -- %</span>
          <span id="presion-actual">Presión: -- hPa</span>
          <span id="actualizado-actual">Actualizado: --</span>
        </div>
      </div>

      <div class="chips">
        <span class="chip" id="chip-estacion">ID estación: —</span>
        <span class="chip" id="chip-fecha">Sin fecha</span>
      </div>

      <p class="error hidden" id="error-actual"></p>
    </section>

    <!-- PREVISIÓN 24 HORAS -->
    <section class="card" id="card-forecast">
      <div class="card-header">
        <div class="card-title">
          <span>Previsión 24 h</span>
          <span class="pill" id="city-label">Municipio —</span>
        </div>
        <div class="status-text" id="status-forecast">Esperando datos…</div>
      </div>

      <div class="forecast-list" id="forecast-list">
        <!-- Tarjetas horarias generadas por JS -->
      </div>

      <p class="error hidden" id="error-forecast"></p>

      <div class="toolbar">
        <span id="last-update">—</span>
        <button id="btn-refresh" class="btn-refresh">
          <span>Actualizar</span>
        </button>
      </div>
    </section>

    <!-- HISTÓRICO PRESIÓN 7 DÍAS -->
    <section class="card" id="card-presion">
      <div class="card-header">
        <div class="card-title">
          <span>Histórico presión (7 días)</span>
          <span class="pill" id="presion-label">Estación —</span>
        </div>
        <div class="status-text" id="status-presion">Esperando datos…</div>
      </div>

      <div style="overflow-x:auto; margin-top:4px;">
        <table style="width:100%; border-collapse:collapse; font-size:0.7rem;">
          <thead>
            <tr style="color:#9ca3af;">
              <th style="text-align:left; padding:4px 2px; border-bottom:1px solid rgba(55,65,81,0.8);">
                Fecha
              </th>
              <th style="text-align:right; padding:4px 2px; border-bottom:1px solid rgba(55,65,81,0.8);">
                Pres. máx (hPa)
              </th>
              <th style="text-align:right; padding:4px 2px; border-bottom:1px solid rgba(55,65,81,0.8);">
                Pres. mín (hPa)
              </th>
            </tr>
          </thead>
          <tbody id="tabla-presion-cuerpo">
            <!-- Filas generadas por JS -->
          </tbody>
        </table>
      </div>

      <p class="error hidden" id="error-presion"></p>
    </section>

    <footer>
      Fuente: AEMET OpenData. Esta aplicación no es oficial.
    </footer>
  </div>

  <script>
    // ==========================
    // CONFIGURACIÓN BÁSICA
    // ==========================

    const API_KEY = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJxdWlqb3Rlcm9Ab3V0bG9vay5lcyIsImp0aSI6IjQwMzhlYzI5LTg0ZDUtNGQxNS1iMDBkLTUwOWE0NmI5NjhjYSIsImlzcyI6IkFFTUVUIiwiaWF0IjoxNzQxNTUzNTE0LCJ1c2VySWQiOiI0MDM4ZWMyOS04NGQ1LTRkMTUtYjAwZC01MDlhNDZiOTY4Y2EiLCJyb2xlIjoiIn0.P6gmbNhBkvOo1LfkDw54uISVFuJxuGmc36FmqMZhgOU"; // Sustituye por tu API Key
    
    //const CODIGO_MUNICIPIO = "28079";        // Ejemplo: 28079 = Madrid
    //const ID_ESTACION = "3195";              // Ejemplo: 3195 = Madrid Retiro
    
    const CODIGO_MUNICIPIO = "14021";        // Ejemplo: 14021 = Córdoba
    const ID_ESTACION = "5402";              // Ejemplo: 5402 = Aeropuerto de Córdoba
    const API_BASE = "https://opendata.aemet.es/opendata";

    // ==========================
    // UTILIDADES GENERALES
    // ==========================

    function formateaFecha(fechaTexto) {
      if (!fechaTexto) return "--";
      const fecha = new Date(fechaTexto);
      if (isNaN(fecha.getTime())) return fechaTexto;
      const opciones = {
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      };
      return fecha.toLocaleString("es-ES", opciones);
    }

    function muestraError(id, mensaje) {
      const el = document.getElementById(id);
      el.textContent = mensaje;
      el.classList.remove("hidden");
    }

    function limpiaError(id) {
      const el = document.getElementById(id);
      el.textContent = "";
      el.classList.add("hidden");
    }

    async function fetchAemet(urlConRuta) {
      const urlPrimaria = `${API_BASE}${urlConRuta}?api_key=${encodeURIComponent(API_KEY)}`;
      const respMeta = await fetch(urlPrimaria);
      if (!respMeta.ok) {
        throw new Error(`Error HTTP AEMET (meta): ${respMeta.status}`);
      }
      const meta = await respMeta.json();
      if (!meta.datos) {
        throw new Error("Respuesta de AEMET sin campo 'datos'");
      }
      const respDatos = await fetch(meta.datos);
      if (!respDatos.ok) {
        throw new Error(`Error HTTP AEMET (datos): ${respDatos.status}`);
      }
      return await respDatos.json();
    }

    // ==========================
    // TIEMPO ACTUAL (OBSERVACIÓN)
    // ==========================

    async function cargaTiempoActual() {
      const statusEl = document.getElementById("status-actual");
      statusEl.textContent = "Cargando…";
      limpiaError("error-actual");

      try {
        if (!API_KEY || API_KEY === "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJxdWlqb3Rlcm9Ab3V0bG9vay5lcyIsImp0aSI6IjQwMzhlYzI5LTg0ZDUtNGQxNS1iMDBkLTUwOWE0NmI5NjhjYSIsImlzcyI6IkFFTUVUIiwiaWF0IjoxNzQxNTUzNTE0LCJ1c2VySWQiOiI0MDM4ZWMyOS04NGQ1LTRkMTUtYjAwZC01MDlhNDZiOTY4Y2EiLCJyb2xlIjoiIn0.P6gmbNhBkvOo1LfkDw54uISVFuJxuGmc36FmqMZhgOU") {
          throw new Error("Falta la API Key de AEMET. Edita el código y rellena la constante API_KEY.");
        }

        const ruta = `/api/observacion/convencional/datos/estacion/${ID_ESTACION}`;
        const data = await fetchAemet(ruta);

        if (!Array.isArray(data) || data.length === 0) {
          throw new Error("Sin datos de observación para la estación indicada.");
        }

        const ultimo = data[data.length - 1];

        const temp = ultimo.ta ?? ultimo.tamin ?? ultimo.tamax ?? null;
        const hum = ultimo.hr ?? null;
        const pres = ultimo.pres ?? ultimo.qnh ?? null;
        const fecha = ultimo.fint ?? ultimo.fenomeno ?? null;

        document.getElementById("temp-actual").innerHTML =
          (temp !== null ? (temp.toFixed ? temp.toFixed(1) : temp) : "--") + "<span>°C</span>";
        document.getElementById("humedad-actual").textContent =
          `Humedad: ${hum !== null ? hum : "--"} %`;
        document.getElementById("presion-actual").textContent =
          `Presión: ${pres !== null ? pres : "--"} hPa`;
        document.getElementById("actualizado-actual").textContent =
          `Actualizado: ${formateaFecha(fecha)}`;

        document.getElementById("station-label").textContent =
          `Estación ${ultimo.nombre || ""}`.trim();
        document.getElementById("chip-estacion").textContent =
          `ID estación: ${ultimo.idema || ID_ESTACION}`;
        document.getElementById("chip-fecha").textContent =
          formateaFecha(fecha);

        statusEl.textContent = "Datos actualizados";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al cargar";
        muestraError(
          "error-actual",
          "No se ha podido obtener el tiempo actual. Revisa la API Key, el ID de estación o inténtalo de nuevo más tarde."
        );
      }
    }

    // ==========================
    // PREVISIÓN 24 HORAS (HORARIA)
    // ==========================

    function extraeHorasPrediccion(json) {
      if (!Array.isArray(json) || json.length === 0) {
        return [];
      }
      const raiz = json[0];
      const pred = raiz.prediccion;
      if (!pred || !Array.isArray(pred.dia) || pred.dia.length === 0) {
        return [];
      }
      const dia0 = pred.dia[0];

      const tempArray = Array.isArray(dia0.temperatura) ? dia0.temperatura : [];
      const cieloArray = Array.isArray(dia0.estadoCielo) ? dia0.estadoCielo : [];

      const mapaTemp = {};
      tempArray.forEach(t => {
        if (t.periodo != null) {
          mapaTemp[String(t.periodo).padStart(2, "0")] = t.value;
        }
      });

      const mapaCielo = {};
      cieloArray.forEach(c => {
        if (c.periodo != null) {
          mapaCielo[String(c.periodo).padStart(2, "0")] = c.descripcion || c.value || "";
        }
      });

      const horas = Object.keys(mapaTemp)
        .concat(Object.keys(mapaCielo))
        .filter((v, i, arr) => arr.indexOf(v) === i)
        .sort();

      const ahora = new Date();
      const horaActual = ahora.getHours();

      const resultado = [];
      for (let i = 0; i < horas.length; i++) {
        const h = parseInt(horas[i], 10);
        if (h >= horaActual && h < horaActual + 24) {
          resultado.push({
            hora: horas[i],
            temp: mapaTemp[horas[i]],
            cielo: mapaCielo[horas[i]] || ""
          });
        }
      }

      if (resultado.length === 0) {
        return horas.slice(0, 24).map(h => ({
          hora: h,
          temp: mapaTemp[h],
          cielo: mapaCielo[h] || ""
        }));
      }

      return resultado.slice(0, 24);
    }

    function pintaPrevision(listaHoras, nombreMunicipio) {
      const cont = document.getElementById("forecast-list");
      cont.innerHTML = "";

      if (!listaHoras || listaHoras.length === 0) {
        cont.innerHTML = "<span style='font-size:0.75rem;color:#9ca3af;'>Sin datos de previsión.</span>";
        return;
      }

      listaHoras.forEach(item => {
        const div = document.createElement("div");
        div.className = "forecast-item";

        const hEl = document.createElement("div");
        hEl.className = "forecast-hour";
        hEl.textContent = `${item.hora} h`;

        const tEl = document.createElement("div");
        tEl.className = "forecast-temp";
        tEl.textContent = item.temp != null ? `${item.temp}°C` : "--°C";

        const dEl = document.createElement("div");
        dEl.className = "forecast-desc";
        dEl.textContent = item.cielo || "—";

        div.appendChild(hEl);
        div.appendChild(tEl);
        div.appendChild(dEl);
        cont.appendChild(div);
      });

      if (nombreMunicipio) {
        document.getElementById("city-label").textContent = nombreMunicipio;
      }
    }

    async function cargaPrevision() {
      const statusEl = document.getElementById("status-forecast");
      const lastUpdateEl = document.getElementById("last-update");
      statusEl.textContent = "Cargando…";
      limpiaError("error-forecast");

      try {
        if (!API_KEY || API_KEY === "TU_API_KEY_AEMET_AQUI") {
          throw new Error("Falta la API Key de AEMET. Edita el código y rellena la constante API_KEY.");
        }

        const ruta = `/api/prediccion/especifica/municipio/horaria/${CODIGO_MUNICIPIO}`;
        const data = await fetchAemet(ruta);

        const listaHoras = extraeHorasPrediccion(data);
        const nombreMunicipio =
          (Array.isArray(data) && data[0] && (data[0].nombre || data[0].municipio)) || "";

        pintaPrevision(listaHoras, nombreMunicipio);

        const elaborado = Array.isArray(data) && data[0] ? data[0].elaborado : null;
        lastUpdateEl.textContent = elaborado
          ? `Elaborado: ${formateaFecha(elaborado)}`
          : "Elaborado: —";

        statusEl.textContent = "Datos actualizados";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al cargar";
        muestraError(
          "error-forecast",
          "No se ha podido obtener la previsión. Revisa la API Key, el código de municipio o inténtalo más tarde."
        );
      }
    }

// ==========================
// HISTÓRICO PRESIÓN (ÚLTIMA SEMANA)
// ==========================

function fechaUTC00(d) {
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth() + 1).padStart(2, "0");
  const day = String(d.getUTCDate()).padStart(2, "0");
  return `${y}-${m}-${day}T00:00:00UTC`;
}

function fechaUTC2359(d) {
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth() + 1).padStart(2, "0");
  const day = String(d.getUTCDate()).padStart(2, "0");
  return `${y}-${m}-${day}T23:59:59UTC`;
}

async function cargaHistoricoPresion() {
  const statusEl = document.getElementById("status-presion");
  statusEl.textContent = "Cargando…";
  limpiaError("error-presion");

  try {
    if (!API_KEY || API_KEY === "TU_API_KEY_AEMET_AQUI") {
      throw new Error("Falta la API Key de AEMET. Edita el código y rellena la constante API_KEY.");
    }

    // Últimos 7 días completos (hoy incluido)
    const hoyUTC = new Date();
    const fin = new Date(Date.UTC(
      hoyUTC.getUTCFullYear(),
      hoyUTC.getUTCMonth(),
      hoyUTC.getUTCDate()
    ));
    const inicio = new Date(fin);
    inicio.setUTCDate(inicio.getUTCDate() - 6);

    const fechaIniStr = fechaUTC00(inicio);
    const fechaFinStr = fechaUTC2359(fin);

    // Endpoint documentado en el HTML de AEMET
    const ruta =
      `/api/valores/climatologicos/diarios/datos/fechaini/${fechaIniStr}/fechafin/${fechaFinStr}/estacion/${ID_ESTACION}`;
    const data = await fetchAemet(ruta);

    if (!Array.isArray(data) || data.length === 0) {
      throw new Error("Sin datos climatológicos para la estación en este rango.");
    }

    // Ordenar por fecha ascendente
    data.sort((a, b) => (a.fecha > b.fecha ? 1 : -1));

    // Detectar dinámicamente las claves de presión máxima y mínima
    const ejemplo = data[0];
    const claves = Object.keys(ejemplo);

    const clavePresMax = claves.find(k =>
      k.toLowerCase().includes("pres") && k.toLowerCase().includes("max")
    );
    const clavePresMin = claves.find(k =>
      k.toLowerCase().includes("pres") && k.toLowerCase().includes("min")
    );

    // Opcional: te ayuda a ver en consola qué campos hay realmente
    console.log("Ejemplo de día climatológico:", ejemplo);
    console.log("Clave presión máxima:", clavePresMax, "Clave presión mínima:", clavePresMin);

    const tbody = document.getElementById("tabla-presion-cuerpo");
    tbody.innerHTML = "";

    data.forEach(dia => {
      const tr = document.createElement("tr");

      const tdFecha = document.createElement("td");
      tdFecha.style.padding = "4px 2px";
      tdFecha.textContent = dia.fecha || "";

      const tdMax = document.createElement("td");
      tdMax.style.padding = "4px 2px";
      tdMax.style.textAlign = "right";
      const valorMax = clavePresMax ? dia[clavePresMax] : null;
      tdMax.textContent =
        valorMax != null && !isNaN(Number(valorMax)) ? Number(valorMax).toFixed(1) : "—";

      const tdMin = document.createElement("td");
      tdMin.style.padding = "4px 2px";
      tdMin.style.textAlign = "right";
      const valorMin = clavePresMin ? dia[clavePresMin] : null;
      tdMin.textContent =
        valorMin != null && !isNaN(Number(valorMin)) ? Number(valorMin).toFixed(1) : "—";

      tr.appendChild(tdFecha);
      tr.appendChild(tdMax);
      tr.appendChild(tdMin);
      tbody.appendChild(tr);
    });

    const nombre = data[0].nombre || "";
    document.getElementById("presion-label").textContent =
      nombre ? `Estación ${nombre}` : `Estación ${ID_ESTACION}`;

    statusEl.textContent = "Datos actualizados";
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error al cargar";
    muestraError(
      "error-presion",
      "No se ha podido obtener el histórico de presión. Revisa la API Key, el ID de estación o inténtalo más tarde."
    );
  }
}

    // ==========================
    // INICIALIZACIÓN
    // ==========================

    async function inicializa() {
      await Promise.all([
        cargaTiempoActual(),
        cargaPrevision(),
        cargaHistoricoPresion()
      ]);
    }

    document.getElementById("btn-refresh").addEventListener("click", async () => {
      const btn = document.getElementById("btn-refresh");
      btn.disabled = true;
      btn.textContent = "Actualizando…";
      await inicializa();
      btn.disabled = false;
      btn.textContent = "Actualizar";
    });

    inicializa();
  </script>
</body>
</html>
